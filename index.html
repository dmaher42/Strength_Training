<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Fitness Plan (DB + Knee-Friendly)</title>
  <style>
    :root{
      --bg-page:#f3f7fb; --bg-panel:#fff; --bg-muted:#f0f4ff;
      --text:#0f172a; --muted:#475569; --line:#d7e3f5;
      --accent:#5f8df5; --accent2:#8ab4ff;
      --done:#10b981; --missed:#ef4444;
      --shadow-lg:0 18px 36px rgba(15,23,42,.12);
      --shadow-sm:0 10px 20px rgba(15,23,42,.08);
      --r-lg:18px; --r-md:14px; --r-sm:10px;
      --s1:6px; --s2:10px; --s3:14px; --s4:18px; --s5:22px;
      --t-sm:12px; --t-md:14px; --t-lg:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg-page); color:var(--text); line-height:1.5;
    }
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(255,255,255,.9); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      max-width:1100px; margin:0 auto; padding:var(--s3);
      display:flex; align-items:center; justify-content:space-between; gap:var(--s3); flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:var(--s2)}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff; display:grid; place-items:center; font-weight:900;
      box-shadow:var(--shadow-sm);
    }
    h1{margin:0; font-size:var(--t-lg); letter-spacing:.2px}
    .sub{margin-top:2px; font-size:var(--t-sm); color:var(--muted)}
    .controls{display:flex; gap:var(--s2); flex-wrap:wrap; align-items:center}
    button,select,input{
      border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:var(--r-md); padding:10px 12px;
      font-weight:800; box-shadow:var(--shadow-sm);
    }
    button{cursor:pointer}
    button:active{transform:translateY(1px)}
    select,input{font-weight:700}
    main{max-width:1100px; margin:0 auto; padding:var(--s3) var(--s3) 90px}
    .card{
      margin-top:var(--s3); padding:var(--s3);
      border:1px solid var(--line); border-radius:var(--r-lg);
      background:var(--bg-panel); box-shadow:var(--shadow-lg);
      display:flex; flex-direction:column; gap:var(--s3);
    }
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:var(--s3)}
    .fg{display:flex; flex-direction:column; gap:6px}
    label{font-weight:900}
    small{color:var(--muted); font-size:var(--t-sm)}
    .week-meta{
      display:flex; align-items:center; justify-content:space-between; gap:var(--s3); flex-wrap:wrap;
      padding:var(--s3); border:1px solid var(--line); border-radius:var(--r-lg);
      background:linear-gradient(180deg, rgba(234,242,255,.8), #fff);
      box-shadow:var(--shadow-sm);
    }
    .pill{display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:var(--t-sm)}
    .dot{width:10px; height:10px; border-radius:50%}
    .dot.done{background:var(--done)}
    .dot.miss{background:var(--missed)}
    .dot.none{background:#cbd5e1}
    .days{display:flex; flex-direction:column; gap:var(--s3)}
    .day{
      border:1px solid var(--line); border-radius:var(--r-lg); overflow:hidden;
      background:#fff; box-shadow:var(--shadow-sm);
      display:flex; flex-direction:row; min-height:140px;
    }
    @media (max-width: 860px){ .day{flex-direction:column} }
    .rail{
      flex:0 0 230px; padding:var(--s3); border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(226,238,255,.9), #fff);
      display:flex; flex-direction:column; gap:var(--s2);
    }
    @media (max-width: 860px){ .rail{border-right:none; border-bottom:1px solid var(--line)} }
    .dayname{font-weight:900; letter-spacing:.2px}
    .tag{width:fit-content; font-size:var(--t-sm); padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(95,141,245,.12)}
    .body{flex:1; padding:var(--s3); display:flex; flex-direction:column; gap:var(--s2)}
    .blk{
      border:1px solid var(--line); background:var(--bg-muted);
      border-radius:var(--r-md); padding:var(--s2); display:flex; flex-direction:column; gap:6px;
    }
    .blk h3{margin:0; font-size:var(--t-md)}
    ul{margin:6px 0 0 18px}
    .row{display:flex; gap:var(--s2); align-items:center; flex-wrap:wrap}
    .statusbtn{box-shadow:none}
    .statusbtn[data-on="true"]{outline:3px solid rgba(95,141,245,.25)}
    .statusbtn.done{border-color:rgba(16,185,129,.45)}
    .statusbtn.miss{border-color:rgba(239,68,68,.35)}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#fff; border:1px solid var(--line); border-radius:var(--r-md);
      padding:10px 12px; box-shadow:var(--shadow-lg); font-size:var(--t-sm);
      display:none; z-index:99;
    }
    .toast.show{display:block}
    .muted{color:var(--muted)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:#fff}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">WF</div>
      <div>
        <h1>Wife Fitness Plan</h1>
        <div class="sub" id="subtitle">DB + bodyweight • 30–45 min • knee-friendly • 7 days/week</div>
      </div>
    </div>
    <div class="controls">
      <button id="prevWeek" aria-label="Previous week">◀ Week</button>
      <select id="weekSelect" aria-label="Select week"></select>
      <button id="nextWeek" aria-label="Next week">Week ▶</button>
      <button id="reset">Reset</button>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="grid">
      <div class="fg">
        <label for="duration">Session length</label>
        <select id="duration">
          <option value="30">30 minutes</option>
          <option value="35">35 minutes</option>
          <option value="40" selected>40 minutes</option>
          <option value="45">45 minutes</option>
        </select>
        <small>We auto-scale cardio + number of strength rounds.</small>
      </div>
      <div class="fg">
        <label for="kneeMode">Knee-friendly mode</label>
        <select id="kneeMode">
          <option value="on" selected>On (recommended)</option>
          <option value="off">Off (only if pain-free)</option>
        </select>
        <small>On = no jumping, no deep lunges, chair squats only.</small>
      </div>
      <div class="fg">
        <label for="weights">Dumbbell difficulty</label>
        <select id="weights">
          <option value="light" selected>Light</option>
          <option value="mod">Moderate</option>
          <option value="hard">Hard</option>
        </select>
        <small>Just changes the suggested rep ranges.</small>
      </div>
      <div class="fg">
        <label>Progress rule</label>
        <div class="muted">
          When a workout feels “easy”: add <span class="kbd">+2 reps</span> or <span class="kbd">+1–2 kg</span>.
        </div>
        <small>Never push through knee pain.</small>
      </div>
    </div>
  </div>

  <div class="week-meta" id="weekMeta"></div>
  <div class="days" id="days"></div>
</main>

<div class="toast" id="toast"></div>

<script type="module">
  import { WIFE_PLAN } from "./plans/wife.plan.js";
  // ---- storage keys
  const KEY_SETTINGS = "wife_fitness_settings_v1";
  const KEY_STATUS   = "wife_fitness_status_v1"; // per-week, per-day

  const PLAN = WIFE_PLAN.days;

  // ---- plan helpers
  function weekPhase(w){
    const found = WIFE_PLAN.phases.find(p => w <= p.upToWeek);
    return found || WIFE_PLAN.phases[WIFE_PLAN.phases.length - 1];
  }

  function repRange(cfg){
    return WIFE_PLAN.repRanges[cfg.weights] || WIFE_PLAN.repRanges.mod;
  }

  function roundsForDuration(cfg){
    const d = Number(cfg.duration);
    const match = WIFE_PLAN.roundScaling.find(r => d <= r.maxDuration);
    return match ? match.rounds : WIFE_PLAN.roundScaling[WIFE_PLAN.roundScaling.length - 1].rounds;
  }

  function tpl(str, map){
    return str.replace(/{{(.*?)}}/g, (_, k) => map[k.trim()] ?? "");
  }

  function strengthLower(cfg){
    const data = WIFE_PLAN.strength.lower;
    const reps = repRange(cfg);
    const rounds = roundsForDuration(cfg);
    const squat = cfg.kneeMode === "on" ? data.squat.on : data.squat.off;
    return [
      tpl(data.intro, { rounds }),
      ...data.moves.map(m => tpl(m, { reps, squat }))
    ];
  }

  function strengthUpper(cfg){
    const data = WIFE_PLAN.strength.upper;
    const reps = repRange(cfg);
    const rounds = roundsForDuration(cfg);
    return [
      tpl(data.intro, { rounds }),
      ...data.moves.map(m => tpl(m, { reps }))
    ];
  }

  function strengthFull(cfg){
    const data = WIFE_PLAN.strength.full;
    const reps = repRange(cfg);
    const rounds = roundsForDuration(cfg);
    const squat = cfg.kneeMode === "on" ? data.squat.on : data.squat.off;
    return [
      tpl(data.intro, { rounds }),
      ...data.moves.map(m => tpl(m, { reps, squat }))
    ];
  }

  function cardioSteady(cfg){
    const d = Number(cfg.duration);
    const main = Math.max(20, d - 10);
    const data = WIFE_PLAN.cardio.steady;
    return [
      tpl(data.headline, { minutes: main }),
      data.effort
    ];
  }

  function cardioIntervals(cfg){
    const phase = weekPhase(cfg.week).name;
    const data = WIFE_PLAN.cardio.intervals;
    const rounds = data.rounds[phase];
    return data.pattern.map(line => tpl(line, { rounds }));
  }

  function lightCardio(cfg){
    const d = Number(cfg.duration);
    const main = Math.max(20, d - 10);
    const data = WIFE_PLAN.cardio.light;
    return [
      tpl(data.headline, { minutes: main }),
      data.effort
    ];
  }

  function buildBlock(def, cfg){
    if (def.type === "strengthLower") return { title: WIFE_PLAN.strength.lower.title, items: strengthLower(cfg) };
    if (def.type === "strengthUpper") return { title: WIFE_PLAN.strength.upper.title, items: strengthUpper(cfg) };
    if (def.type === "strengthFull")  return { title: WIFE_PLAN.strength.full.title, items: strengthFull(cfg) };
    if (def.type === "cardioSteady")   return { title: def.title, items: cardioSteady(cfg) };
    if (def.type === "cardioIntervals")return { title: def.title, items: cardioIntervals(cfg) };
    if (def.type === "lightCardio")    return { title: def.title, items: lightCardio(cfg) };
    return { title: def.title, items: def.items };
  }

  // ---- rendering + state
  const elDays = document.getElementById("days");
  const elMeta = document.getElementById("weekMeta");
  const elWeek = document.getElementById("weekSelect");
  const elToast = document.getElementById("toast");

  document.getElementById("subtitle").textContent = WIFE_PLAN.subtitle;

  const settings = load(KEY_SETTINGS, {
    week: 1,
    duration: "40",
    kneeMode: "on",
    weights: "light"
  });

  // week select
  for (let i=1;i<=WIFE_PLAN.weeks;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Week ${i}`;
    elWeek.appendChild(opt);
  }

  // hydrate controls
  document.getElementById("duration").value = settings.duration;
  document.getElementById("kneeMode").value = settings.kneeMode;
  document.getElementById("weights").value = settings.weights;
  elWeek.value = String(settings.week);

  document.getElementById("duration").addEventListener("change", (e)=>{ settings.duration = e.target.value; save(KEY_SETTINGS, settings); render(); toast("Saved."); });
  document.getElementById("kneeMode").addEventListener("change", (e)=>{ settings.kneeMode = e.target.value; save(KEY_SETTINGS, settings); render(); toast("Saved."); });
  document.getElementById("weights").addEventListener("change", (e)=>{ settings.weights = e.target.value; save(KEY_SETTINGS, settings); render(); toast("Saved."); });

  elWeek.addEventListener("change", (e)=>{ settings.week = Number(e.target.value); save(KEY_SETTINGS, settings); render(); });

  document.getElementById("prevWeek").addEventListener("click", ()=>{
    settings.week = Math.max(1, settings.week - 1);
    elWeek.value = String(settings.week);
    save(KEY_SETTINGS, settings);
    render();
  });
  document.getElementById("nextWeek").addEventListener("click", ()=>{
    settings.week = Math.min(WIFE_PLAN.weeks, settings.week + 1);
    elWeek.value = String(settings.week);
    save(KEY_SETTINGS, settings);
    render();
  });

  document.getElementById("reset").addEventListener("click", ()=>{
    if (!confirm("Reset ALL saved status + settings?")) return;
    localStorage.removeItem(KEY_SETTINGS);
    localStorage.removeItem(KEY_STATUS);
    location.reload();
  });

  function render(){
    const cfg = { ...settings, week: Number(settings.week) };
    const phase = weekPhase(cfg.week);
    const status = load(KEY_STATUS, {});
    const weekKey = `w${cfg.week}`;

    // meta
    const doneCount = PLAN.reduce((acc, _, idx)=>{
      const s = (status[weekKey]||{})[idx];
      return acc + (s === "done" ? 1 : 0);
    },0);
    const missCount = PLAN.reduce((acc, _, idx)=>{
      const s = (status[weekKey]||{})[idx];
      return acc + (s === "missed" ? 1 : 0);
    },0);

    elMeta.innerHTML = `
      <div>
        <div style="font-weight:900;font-size:16px">Week ${cfg.week} • ${phase.name}</div>
        <div class="muted" style="font-size:12px">${phase.note}</div>
      </div>
      <div class="row">
        <span class="pill"><span class="dot done"></span>Done: <b>${doneCount}</b></span>
        <span class="pill"><span class="dot miss"></span>Missed: <b>${missCount}</b></span>
        <span class="pill"><span class="dot none"></span>Planned: <b>${PLAN.length - doneCount - missCount}</b></span>
      </div>
    `;

    // days
    elDays.innerHTML = "";
    PLAN.forEach((d, idx)=>{
      const dayStatus = ((status[weekKey]||{})[idx]) || "planned";
      const blocks = d.blocks.map(b => buildBlock(b, cfg));

      const dayEl = document.createElement("div");
      dayEl.className = "day";
      dayEl.innerHTML = `
        <div class="rail">
          <div class="dayname">${d.day}</div>
          <div style="font-weight:900">${d.focus}</div>
          <div class="tag">${d.tag}</div>
          <div class="muted" style="font-size:12px">Target: ${cfg.duration} min</div>
          <div class="row" style="margin-top:6px">
            <button class="statusbtn done" data-action="done">Mark done</button>
            <button class="statusbtn miss" data-action="missed">Mark missed</button>
            <button class="statusbtn" data-action="planned">Clear</button>
          </div>
          <div class="muted" style="font-size:12px">
            Status: <b>${dayStatus}</b>
          </div>
        </div>
        <div class="body"></div>
      `;

      const body = dayEl.querySelector(".body");
      blocks.forEach(b=>{
        const blkEl = document.createElement("div");
        blkEl.className = "blk";
        blkEl.innerHTML = `
          <h3>${b.title}</h3>
          <ul>${b.items.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
        `;
        body.appendChild(blkEl);
      });

      dayEl.querySelectorAll("button.statusbtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const action = btn.getAttribute("data-action");
          const st = load(KEY_STATUS, {});
          st[weekKey] = st[weekKey] || {};
          if (action === "planned") delete st[weekKey][idx];
          else st[weekKey][idx] = action;
          save(KEY_STATUS, st);
          toast(action === "planned" ? "Cleared." : `Marked ${action}.`);
          render();
        });
      });

      elDays.appendChild(dayEl);
    });
  }

  function toast(msg){
    elToast.textContent = msg;
    elToast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>elToast.classList.remove("show"), 1400);
  }

  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k, fallback){
    try{
      const raw = localStorage.getItem(k);
      return raw ? JSON.parse(raw) : fallback;
    }catch(e){ return fallback; }
  }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  render();
</script>
</body>
</html>
